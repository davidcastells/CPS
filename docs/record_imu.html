<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>IMU Recorder (9 values)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f1724;--accent:#ffd54f}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{background:linear-gradient(180deg,#051022 0%, #071427 60%);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:12px}
    .app{width:100%;max-width:400px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,.6)}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center;}
    button{background:var(--accent);border:0;padding:10px 12px;border-radius:8px;font-weight:600;cursor:pointer;}
    button:disabled{opacity:0.5;cursor:not-allowed;}
    .panel{padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-top:12px;}
    .values{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .val{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;min-width:120px;}
    .small{font-size:12px;color:#9fb0d7}
    footer{font-size:12px;color:#9fb0d7;margin-top:8px}
    .record-status{padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:14px;margin-top:10px;text-align:center;}
    .recording{color:#ff5252;font-weight:bold;}
    .status-row{display:flex; justify-content:space-between; align-items:center;}
    @media(max-width:820px){.row{flex-direction:column}.panel{width:100%}}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>IMU Recorder (9 values)</h1>
  </header>

  <div class="controls">
    <button id="startBtn">Start Sensors</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="recordBtn" disabled>Start Recording</button>
    <button id="copyCsvBtn" disabled>Copy CSV to Clipboard</button>
  </div>

  <div id="recordStatus" class="record-status">Recording Status: Not started.</div>

  <div class="panel">
    <h3 style="margin:0 0 8px 0">IMU — Live Values</h3>
    <div class="values">
      <div class="val"><div class="small">accel x</div><div id="ax">—</div></div>
      <div class="val"><div class="small">accel y</div><div id="ay">—</div></div>
      <div class="val"><div class="small">accel z</div><div id="az">—</div></div>

      <div class="val"><div class="small">gyro x (deg/s)</div><div id="gx">—</div></div>
      <div class="val"><div class="small">gyro y (deg/s)</div><div id="gy">—</div></div>
      <div class="val"><div class="small">gyro z (deg/s)</div><div id="gz">—</div></div>

      <div class="val"><div class="small">mag x (µT)</div><div id="mx">—</div></div>
      <div class="val"><div class="small">mag y (µT)</div><div id="my">—</div></div>
      <div class="val"><div class="small">mag z (µT)</div><div id="mz">—</div></div>
    </div>

    <footer>
      Notes: Requires HTTPS. On iOS, you may need to grant motion & orientation access manually.
    </footer>
  </div>
</div>

<script>
(async function(){
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const recordBtn = document.getElementById('recordBtn');
  const copyCsvBtn = document.getElementById('copyCsvBtn');
  const recordStatusEl = document.getElementById('recordStatus');

  // UI elements for live data
  const axEl = document.getElementById('ax');
  const ayEl = document.getElementById('ay');
  const azEl = document.getElementById('az');
  const gxEl = document.getElementById('gx');
  const gyEl = document.getElementById('gy');
  const gzEl = document.getElementById('gz');
  const mxEl = document.getElementById('mx');
  const myEl = document.getElementById('my');
  const mzEl = document.getElementById('mz');

  let sensors = {acc:null, gyro:null, mag:null};
  let currentImu = {ax:null, ay:null, az:null, gx:null, gy:null, gz:null, mx:null, my:null, mz:null};
  let isRecording = false;
  let recordedData = [];
  let startTime = null;
  
  // Format helper function
  function format(v){return (v===null||v===undefined)?'—':(Number(v).toFixed(3));}

  // Function to update both the UI and the currentImu object
  function updateImuDisplay(key, val) {
    currentImu[key] = val; // Update current value for recording
    const el = document.getElementById(key);
    if(el) el.textContent = format(val);
  }

  async function requestSensorPermissions(){
    // iOS: DeviceMotionEvent.requestPermission
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
      try{ await DeviceMotionEvent.requestPermission(); }catch(e){console.warn(e)}
    }
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
      try{ await DeviceOrientationEvent.requestPermission(); }catch(e){/*ignore*/}
    }
  }

  async function startSensors(){
    startBtn.disabled = true;
    await requestSensorPermissions();

    // Generic Sensor API
    try{
      // Accelerometer
      if ('Accelerometer' in window){
        sensors.acc = new Accelerometer({frequency:60});
        sensors.acc.addEventListener('reading', ()=>{
          updateImuDisplay('ax', sensors.acc.x);
          updateImuDisplay('ay', sensors.acc.y);
          updateImuDisplay('az', sensors.acc.z);
          recordCurrentData();
        });
        sensors.acc.start();
      }
      // Gyroscope
      if ('Gyroscope' in window){
        sensors.gyro = new Gyroscope({frequency:60});
        sensors.gyro.addEventListener('reading', ()=>{
          updateImuDisplay('gx', sensors.gyro.x);
          updateImuDisplay('gy', sensors.gyro.y);
          updateImuDisplay('gz', sensors.gyro.z);
        });
        sensors.gyro.start();
      }
      // Magnetometer
      if ('Magnetometer' in window){
        sensors.mag = new Magnetometer({frequency:30});
        sensors.mag.addEventListener('reading', ()=>{
          updateImuDisplay('mx', sensors.mag.x);
          updateImuDisplay('my', sensors.mag.y);
          updateImuDisplay('mz', sensors.mag.z);
        });
        sensors.mag.start();
      }
    }catch(e){
      console.warn('Generic Sensor API not available or blocked', e);
    }

    // Fallback to DeviceMotion/DeviceOrientation if Generic Sensor API failed
    if (!sensors.acc || !sensors.gyro){
      if ('DeviceMotionEvent' in window){
        window.addEventListener('devicemotion', (ev)=>{
          const a = ev.acceleration || ev.accelerationIncludingGravity;
          if (a){
            updateImuDisplay('ax', a.x); updateImuDisplay('ay', a.y); updateImuDisplay('az', a.z);
          }
          if (ev.rotationRate){
            updateImuDisplay('gx', ev.rotationRate.alpha); updateImuDisplay('gy', ev.rotationRate.beta); updateImuDisplay('gz', ev.rotationRate.gamma);
          }
          recordCurrentData(); // Record on fallback event frequency
        });
      }
    }

    if (!sensors.mag){
      if ('DeviceOrientationEvent' in window){
        window.addEventListener('deviceorientation', (ev)=>{
          // Using orientation for mag fallback (less accurate but better than nothing)
          updateImuDisplay('mx', ev.alpha); updateImuDisplay('my', ev.beta); updateImuDisplay('mz', ev.gamma);
        });
      }
    }
    
    // Check if any sensor started
    if (sensors.acc || sensors.gyro || sensors.mag || 'DeviceMotionEvent' in window) {
      stopBtn.disabled = false;
      recordBtn.disabled = false;
      recordStatusEl.textContent = 'Sensors running. Ready to record.';
    } else {
      alert('Could not start any sensors. Please check browser support and permissions (requires HTTPS).');
      startBtn.disabled = false;
    }
  }

  function stopSensors(){
    startBtn.disabled = false;
    stopBtn.disabled = true;
    recordBtn.disabled = true;
    
    toggleRecording(false); // Stop recording if active

    // Stop Generic Sensors
    for (const k of Object.keys(sensors)){
      const s = sensors[k];
      try{ if (s && s.stop) s.stop(); }catch(e){}
      sensors[k]=null;
    }

    // Clean up Fallback listeners (requires page reload to fully clear, but functionally stopping here)
    recordStatusEl.textContent = 'Sensors stopped.';
  }
  
  // Record IMU data on every sensor reading event
  function recordCurrentData() {
    if (isRecording && startTime !== null) {
      const timestamp = Date.now() - startTime; // Time offset from start
      // Clone the current IMU data
      recordedData.push({ 
        timestamp: timestamp,
        ...currentImu 
      });
      recordStatusEl.innerHTML = `<span class="recording">Recording...</span> ${recordedData.length} samples collected.`;
    }
  }

  function toggleRecording(forceState = !isRecording){
    isRecording = forceState;
    recordBtn.textContent = isRecording ? 'Stop Recording' : 'Start Recording';
    if (isRecording) {
      startTime = Date.now();
      recordedData = []; // Clear previous data
      recordStatusEl.innerHTML = `<span class="recording">Recording...</span> ${recordedData.length} samples.`;
      copyCsvBtn.disabled = true;
    } else {
      recordStatusEl.textContent = `Recording stopped. ${recordedData.length} samples collected.`;
      copyCsvBtn.disabled = recordedData.length === 0;
    }
  }

  function copyCsvToClipboard(){
    if (recordedData.length === 0) {
      alert('No data to copy. Start recording first.');
      return;
    }
    
    // Header row for CSV
    const header = ['timestamp_ms', 'accel_x', 'accel_y', 'accel_z', 'gyro_x', 'gyro_y', 'gyro_z', 'mag_x', 'mag_y', 'mag_z'];
    const csv = [header.join(',')];
    
    // Data rows
    recordedData.forEach(row => {
      const values = [
        row.timestamp,
        row.ax, row.ay, row.az,
        row.gx, row.gy, row.gz,
        row.mx, row.my, row.mz
      ];
      // Replace null values with empty string and limit precision
      csv.push(values.map(v => v === null || v === '—' ? '' : Number(v).toFixed(6)).join(','));
    });
    
    const csvString = csv.join('\n');

    navigator.clipboard.writeText(csvString).then(() => {
      alert(`Copied ${recordedData.length} IMU samples to clipboard!`);
      recordStatusEl.textContent = `Copied ${recordedData.length} samples.`;
    }).catch(err => {
      console.error('Could not copy text: ', err);
      alert('Failed to copy data to clipboard. See console for error.');
    });
  }
  
  // Event listeners
  startBtn.addEventListener('click', startSensors);
  stopBtn.addEventListener('click', stopSensors);
  recordBtn.addEventListener('click', () => toggleRecording());
  copyCsvBtn.addEventListener('click', copyCsvToClipboard);

})();
</script>
</body>
</html>
